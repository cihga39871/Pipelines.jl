<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Tips &amp; Troubleshoots · Pipelines.jl</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit">Pipelines.jl</span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><span class="tocitem">Manual</span><ul><li><a class="tocitem" href="../command_program/">Command Program</a></li><li><a class="tocitem" href="../julia_program/">Julia Program</a></li><li><a class="tocitem" href="../command_dependency/">Command Dependency</a></li></ul></li><li><a class="tocitem" href="../API/">API</a></li><li class="is-active"><a class="tocitem" href>Tips &amp; Troubleshoots</a><ul class="internal"><li><a class="tocitem" href="#Named-tuple-for-common-arguments"><span>Named tuple for common arguments</span></a></li><li><a class="tocitem" href="#Run-different-programs-in-parallel"><span>Run different programs in parallel</span></a></li><li><a class="tocitem" href="#Name-of-inputs-and-outputs:-String-or-Symbol?"><span>Name of inputs and outputs: String or Symbol?</span></a></li><li><a class="tocitem" href="#UndefVarError-in-quote-...-end"><span>UndefVarError in <code>quote ... end</code></span></a></li><li><a class="tocitem" href="#Fail-to-Precompile-a-module-containing-a-Program"><span>Fail to Precompile a module containing a <code>Program</code></span></a></li><li><a class="tocitem" href="#I-changed-Program-inputs,-but-Program-skipped-and-outputs-not-updated"><span>I changed <code>Program</code> inputs, but <code>Program</code> skipped and outputs not updated</span></a></li></ul></li><li><a class="tocitem" href="../changelog/">Change Log</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Tips &amp; Troubleshoots</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Tips &amp; Troubleshoots</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/cihga39871/Pipelines.jl/blob/master/docs/src/tips_and_troubleshoots.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Tips-and-Troubleshoots"><a class="docs-heading-anchor" href="#Tips-and-Troubleshoots">Tips &amp; Troubleshoots</a><a id="Tips-and-Troubleshoots-1"></a><a class="docs-heading-anchor-permalink" href="#Tips-and-Troubleshoots" title="Permalink"></a></h1><p>This page summarizes tips and troubleshoots when building workflow using Pipelines.jl</p><h2 id="Named-tuple-for-common-arguments"><a class="docs-heading-anchor" href="#Named-tuple-for-common-arguments">Named tuple for common arguments</a><a id="Named-tuple-for-common-arguments-1"></a><a class="docs-heading-anchor-permalink" href="#Named-tuple-for-common-arguments" title="Permalink"></a></h2><p>A workflow usually has many <code>Program</code>s, and all <code>Programs</code> have some common run arguments. We can use a named tuple to store and use the common arguments easily.</p><pre><code class="language-julia">using Pipelines

prog_A = CmdProgram(...)
prog_B = JuliaProgram(...)

common_run_args = (check_dependencies = false, skip_when_done = true, touch_run_id_file = true, verbose = :min, retry = 1)

run(prog_A; prog_A_args..., common_run_args...)
run(prog_B; prog_B_args..., common_run_args...)</code></pre><h2 id="Run-different-programs-in-parallel"><a class="docs-heading-anchor" href="#Run-different-programs-in-parallel">Run different programs in parallel</a><a id="Run-different-programs-in-parallel-1"></a><a class="docs-heading-anchor-permalink" href="#Run-different-programs-in-parallel" title="Permalink"></a></h2><p>When building a computational workflow, we may find different programs use different CPU and memory. Some can run simultaneously, but some have to run sequentially. To efficiently use computational resources, we highly recommend to use <a href="https://github.com/cihga39871/JobSchedulers.jl">JobSchedulers.jl</a>. It is stable, useful and powerful package for task queuing and workload management, and are fully compatible with Pipelines.jl</p><p><code>run(prog; prog_args..., run_args...)</code> can be replaced by the JobScheduler way:</p><pre><code class="language-julia">job = Job(prog; prog_args..., run_args..., job_args...)
submit!(job)</code></pre><h3 id="An-example"><a class="docs-heading-anchor" href="#An-example">An example</a><a id="An-example-1"></a><a class="docs-heading-anchor-permalink" href="#An-example" title="Permalink"></a></h3><p>A workflow comprises the following steps:</p><ul><li>Run <code>prog_A</code> with 2 threads and 4GB RAM.</li><li>Run <code>prog_B</code> with 8 threads.</li><li>After <code>prog_A</code> finished, run <code>prog_C</code> (2 threads).</li><li>After <code>prog_B</code> and <code>prog_C</code> finished, run <code>prog_D</code> (12 threads)</li></ul><pre><code class="language-julia">using JobSchedulers, Pipelines

scheduler_start() # start the job scheduler

prog_A = CmdProgram(...)
prog_B = JuliaProgram(...)
prog_C = CmdProgram(...)
prog_D = JuliaProgram(...)

job_A = Job(prog_A, A_args..., ncpu = 2, mem = 4GB)
submit!(job_A)

job_B = Job(prog_B, B_args..., ncpu = 8)
submit!(job_B)

job_C = Job(prog_C, C_args..., ncpu = 2, dependency = DONE =&gt; job_A)
submit!(job_C)

job_D = Job(prog_D, D_args..., ncpu = 12, dependency = [DONE =&gt; job_B, DONE =&gt; job_C])
submit!(job_D)</code></pre><h3 id="Argument-forward"><a class="docs-heading-anchor" href="#Argument-forward">Argument forward</a><a id="Argument-forward-1"></a><a class="docs-heading-anchor-permalink" href="#Argument-forward" title="Permalink"></a></h3><p>Usually a parallel program has an input argument of # cpu, and <code>Job()</code> has a <code>ncpu</code> argument. Because <code>ncpu</code> is reserved (<a href="../API/#Pipelines.RESERVED_KEY_SET"><code>Pipelines.RESERVED_KEY_SET</code></a>) and cannot be used as Program inputs, it is awkward to write code in this way:</p><pre><code class="language-julia">prog = CmdProgram(inputs = [:NCPU =&gt; 1], ...)  # default num CPU is 1
job = Job(prog, NCPU = 8, ncpu = 8)            # use 8 CPUs in the job</code></pre><p>To make life easier, we can define <code>arg_forward</code> in <code>Program</code> to forward the input <code>:NCPU</code> to Job argument <code>ncpu</code>:</p><pre><code class="language-julia">prog = CmdProgram(inputs = [:NCPU =&gt; 1], arg_forward = :NCPU =&gt; :ncpu, ...)
job = Job(prog, NCPU = 8)
# Job:
#   ...
#   ncpu → 8
#   ...</code></pre><div class="admonition is-info"><header class="admonition-header">arg_forward in Program</header><div class="admonition-body"><p><code>arg_forward</code>: forward args from inputs and outputs to specific keywords in <code>JobSchedulers.Job()</code>, only supporting <code>Pipelines.FORWARD_KEY_SET</code>: <code>[:ncpu, :mem, :user, :name]</code>. Elements (or vectors containing elements) in the following format: <code>&quot;arg_of_inputs_or_outputs&quot; =&gt; :key_in_FORWARD_KEY_SET</code>.</p></div></div><h2 id="Name-of-inputs-and-outputs:-String-or-Symbol?"><a class="docs-heading-anchor" href="#Name-of-inputs-and-outputs:-String-or-Symbol?">Name of inputs and outputs: String or Symbol?</a><a id="Name-of-inputs-and-outputs:-String-or-Symbol?-1"></a><a class="docs-heading-anchor-permalink" href="#Name-of-inputs-and-outputs:-String-or-Symbol?" title="Permalink"></a></h2><p>Normally the name should be a String: <code>CmdProgram(inputs = [&quot;IN&quot;], outputs = [&quot;OUT&quot;])</code>. However, if an argument does not affect results (such as number of threads), it is called an <em>independent</em> argument, and has to be a <strong>Symbol</strong>. Symbol arguments are <strong>ignored</strong> when generating unique run IDs to prevent <strong>re-running</strong> a program. Arguments of inputs and outputs will be converted to <a href="../API/#Pipelines.Arg"><code>Arg</code></a> objects.</p><p>See also: <a href="../API/#Pipelines.Arg"><code>Arg</code></a></p><h2 id="UndefVarError-in-quote-...-end"><a class="docs-heading-anchor" href="#UndefVarError-in-quote-...-end">UndefVarError in <code>quote ... end</code></a><a id="UndefVarError-in-quote-...-end-1"></a><a class="docs-heading-anchor-permalink" href="#UndefVarError-in-quote-...-end" title="Permalink"></a></h2><p><code>quote</code> creates a piece of code without using the explicit <code>Expr</code> constructor. It creates an <code>Expr</code> object and follows the scoping rules of Julia <code>Expr</code>ession.</p><p>An <code>Expr</code>ression will be evaluated in the <strong>global scope</strong> of the <strong>Module</strong> defined in <code>Program(..., mod = Module)</code>, <em>and then converted to a function using <a href="../API/#Pipelines.quote_function"><code>Pipelines.quote_function</code></a></em>.</p><p>Thus, directly using local variables (including functions) in <code>Expr</code> will lead to <code>UndefVarError</code>. To use a local variable, you need to follow the rules:</p><ol><li><p>A local variable (include function) should be referenced using <code>$</code> in <code>expr</code>ession.</p></li><li><p>A local <code>::Symbol</code> variable (<code>sym</code>) should be referenced using <code>$(QuoteNode(sym))</code> in <code>expr</code>ession.</p></li></ol><p>Example:</p><pre><code class="language-julia">inputs = [&quot;A&quot;, &quot;B&quot;]
g_var = 3
g_sym = :globalsymbol

function gen_expr()
    l_var = 5
    l_func() = @info(&quot;Use local function&quot;)
    l_sym = :abc
    expr = quote
        @show inputs
        @show g_var
        @show g_sym
        @show $(QuoteNode(l_sym))
        @show $l_var + 2
        $l_func()
        A + B
    end
end

expr = gen_expr()
func = Pipelines.quote_function(expr, inputs; mod = @__MODULE__)

in_dict = Dict(&quot;A&quot; =&gt; 5, &quot;B&quot; =&gt; 50) # func takes Dict{String} as argument
func(in_dict)</code></pre><p>See also: <a href="../API/#Pipelines.quote_expr"><code>quote_expr</code></a></p><h2 id="Fail-to-Precompile-a-module-containing-a-Program"><a class="docs-heading-anchor" href="#Fail-to-Precompile-a-module-containing-a-Program">Fail to Precompile a module containing a <code>Program</code></a><a id="Fail-to-Precompile-a-module-containing-a-Program-1"></a><a class="docs-heading-anchor-permalink" href="#Fail-to-Precompile-a-module-containing-a-Program" title="Permalink"></a></h2><p>It is because you pass <code>quote ... end</code> to a Program, but forget to add <code>mod = @__MODULE__</code> to it.</p><p>Fix is simple:</p><pre><code class="language-julia">prog = CmdProgram(...)                    # fail precompilation
prog = CmdProgram(..., mod = @__MODULE__) # pass precompilation</code></pre><p>See also: <a href="../API/#Pipelines.quote_expr"><code>quote_expr</code></a></p><h2 id="I-changed-Program-inputs,-but-Program-skipped-and-outputs-not-updated"><a class="docs-heading-anchor" href="#I-changed-Program-inputs,-but-Program-skipped-and-outputs-not-updated">I changed <code>Program</code> inputs, but <code>Program</code> skipped and outputs not updated</a><a id="I-changed-Program-inputs,-but-Program-skipped-and-outputs-not-updated-1"></a><a class="docs-heading-anchor-permalink" href="#I-changed-Program-inputs,-but-Program-skipped-and-outputs-not-updated" title="Permalink"></a></h2><p>The <code>Program</code> probably does not read or write files, and you may adjust inputs and outputs back and forth.</p><p>If we have a pure Program without reading and writing files, we cannot guarantee the state of the arguments.</p><p>A work-around is to intentionally create a file with a fixed name, and the file name is defined in Program&#39;s outputs.</p><p>See <a href="../API/#Pipelines.create_run_id_file"><code>Pipelines.create_run_id_file</code></a> to learn how Pipelines.jl decides whether a program needs re-run, and its limitation.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../API/">« API</a><a class="docs-footer-nextpage" href="../changelog/">Change Log »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Monday 21 November 2022 04:06">Monday 21 November 2022</span>. Using Julia version 1.7.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
